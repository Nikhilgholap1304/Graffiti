{"version":3,"file":"cli.js","sources":["../src/prog.js","../src/utils.js","../src/log-error.js","../src/cli.js"],"sourcesContent":["import sade from 'sade';\r\nlet { version } = require('../package');\r\n\r\nconst toArray = val => (Array.isArray(val) ? val : val == null ? [] : [val]);\r\n\r\nexport default handler => {\r\n\tconst ENABLE_MODERN = process.env.MICROBUNDLE_MODERN !== 'false';\r\n\r\n\tconst DEFAULT_FORMATS = ENABLE_MODERN ? 'modern,es,cjs,umd' : 'es,cjs,umd';\r\n\r\n\tconst cmd = type => (str, opts) => {\r\n\t\topts.watch = opts.watch || type === 'watch';\r\n\t\topts.compress =\r\n\t\t\topts.compress != null ? opts.compress : opts.target !== 'node';\r\n\t\topts.entries = toArray(str || opts.entry).concat(opts._);\r\n\t\thandler(opts);\r\n\t};\r\n\r\n\tlet prog = sade('microbundle');\r\n\r\n\tprog\r\n\t\t.version(version)\r\n\t\t.option('--entry, -i', 'Entry module(s)')\r\n\t\t.option('--output, -o', 'Directory to place build files into')\r\n\t\t.option('--format, -f', 'Only build specified formats', DEFAULT_FORMATS)\r\n\t\t.option('--watch, -w', 'Rebuilds on any change', false)\r\n\t\t.option('--target', 'Specify your target environment (node or web)', 'web')\r\n\t\t.option('--external', `Specify external dependencies, or 'none'`)\r\n\t\t.option('--globals', `Specify globals dependencies, or 'none'`)\r\n\t\t.example('microbundle --globals react=React,jquery=$')\r\n\t\t.option('--define', 'Replace constants with hard-coded values')\r\n\t\t.example('microbundle --define API_KEY=1234')\r\n\t\t.option('--alias', `Map imports to different modules`)\r\n\t\t.example('microbundle --alias react=preact')\r\n\t\t.option('--compress', 'Compress output using Terser', null)\r\n\t\t.option('--strict', 'Enforce undefined global context and add \"use strict\"')\r\n\t\t.option('--name', 'Specify name exposed in UMD builds')\r\n\t\t.option('--cwd', 'Use an alternative working directory', '.')\r\n\t\t.option('--sourcemap', 'Generate source map', true)\r\n\t\t.option(\r\n\t\t\t'--css-modules',\r\n\t\t\t'Turns on css-modules for all .css imports. Passing a string will override the scopeName. eg --css-modules=\"_[hash]\"',\r\n\t\t\tnull,\r\n\t\t)\r\n\t\t.example(\"microbundle --no-sourcemap # don't generate sourcemaps\")\r\n\t\t.option('--raw', 'Show raw byte size', false)\r\n\t\t.option('--jsx', 'A custom JSX pragma (default React.createElement)')\r\n\t\t.option('--tsconfig', 'Specify the path to a custom tsconfig.json')\r\n\t\t.example('microbundle build --tsconfig tsconfig.build.json');\r\n\r\n\tprog\r\n\t\t.command('build [...entries]', '', { default: true })\r\n\t\t.describe('Build once and exit')\r\n\t\t.action(cmd('build'));\r\n\r\n\tprog\r\n\t\t.command('watch [...entries]')\r\n\t\t.describe('Rebuilds on any change')\r\n\t\t.action(cmd('watch'));\r\n\r\n\t// Parse argv; add extra aliases\r\n\treturn argv =>\r\n\t\tprog.parse(argv, {\r\n\t\t\talias: {\r\n\t\t\t\to: ['output', 'd'],\r\n\t\t\t\ti: ['entry', 'entries', 'e'],\r\n\t\t\t\tw: ['watch'],\r\n\t\t\t},\r\n\t\t});\r\n};\r\n","import fs from 'fs';\r\nimport { promisify } from 'es6-promisify';\r\n\r\nexport const readFile = promisify(fs.readFile);\r\n// export const writeFile = promisify(fs.writeFile);\r\nexport const stat = promisify(fs.stat);\r\nexport const isDir = name =>\r\n\tstat(name)\r\n\t\t.then(stats => stats.isDirectory())\r\n\t\t.catch(() => false);\r\nexport const isFile = name =>\r\n\tstat(name)\r\n\t\t.then(stats => stats.isFile())\r\n\t\t.catch(() => false);\r\nexport const stdout = console.log.bind(console); // eslint-disable-line no-console\r\nexport const stderr = console.error.bind(console);\r\n\r\nexport const isTruthy = obj => {\r\n\tif (!obj) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn obj.constructor !== Object || Object.keys(obj).length > 0;\r\n};\r\n","import { red, dim } from 'kleur';\r\nimport { stderr } from './utils';\r\n\r\nexport default function(err) {\r\n\tconst error = err.error || err;\r\n\tconst description = `${error.name ? error.name + ': ' : ''}${error.message ||\r\n\t\terror}`;\r\n\tconst message = error.plugin\r\n\t\t? `(${error.plugin} plugin) ${description}`\r\n\t\t: description;\r\n\r\n\tstderr(red().bold(message));\r\n\r\n\tif (error.loc) {\r\n\t\tstderr();\r\n\t\tstderr(`at ${error.loc.file}:${error.loc.line}:${error.loc.column}`);\r\n\t}\r\n\r\n\tif (error.frame) {\r\n\t\tstderr();\r\n\t\tstderr(dim(error.frame));\r\n\t} else if (err.stack) {\r\n\t\tconst headlessStack = error.stack.replace(message, '');\r\n\t\tstderr(dim(headlessStack));\r\n\t}\r\n\r\n\tstderr();\r\n}\r\n","#!/usr/bin/env node\r\n\r\nimport microbundle from '.';\r\nimport prog from './prog';\r\nimport { stdout } from './utils';\r\nimport logError from './log-error';\r\n\r\nconst run = opts => {\r\n\tmicrobundle(opts)\r\n\t\t.then(output => {\r\n\t\t\tif (output != null) stdout(output);\r\n\t\t\tif (!opts.watch) process.exit(0);\r\n\t\t})\r\n\t\t.catch(err => {\r\n\t\t\tprocess.exitCode = (typeof err.code === 'number' && err.code) || 1;\r\n\t\t\tlogError(err);\r\n\t\t\tprocess.exit();\r\n\t\t});\r\n};\r\n\r\nprog(run)(process.argv);\r\n"],"names":["version","require","toArray","val","Array","isArray","handler","ENABLE_MODERN","process","env","MICROBUNDLE_MODERN","DEFAULT_FORMATS","cmd","type","str","opts","watch","compress","target","entries","entry","concat","_","prog","sade","option","example","command","default","describe","action","argv","parse","alias","o","i","w","readFile","promisify","fs","stat","stdout","console","log","bind","stderr","error","err","description","name","message","plugin","red","bold","loc","file","line","column","frame","dim","stack","headlessStack","replace","run","microbundle","then","output","exit","catch","exitCode","code","logError"],"mappings":"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"}